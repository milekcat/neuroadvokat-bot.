import os
import logging
import json
import re
from datetime import datetime
from threading import Lock
from pathlib import Path
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes
from telegram.constants import ParseMode
from telegram.helpers import escape_markdown

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ê ---
logging.basicConfig(format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO)
logger = logging.getLogger(__name__)

NEURO_ADVOCAT_TOKEN = os.environ.get('NEURO_ADVOCAT_TOKEN')
CHAT_ID_FOR_ALERTS = os.environ.get('CHAT_ID_FOR_ALERTS')
TELEGRAM_CHANNEL_URL = os.environ.get('TELEGRAM_CHANNEL_URL')

if not all([NEURO_ADVOCAT_TOKEN, CHAT_ID_FOR_ALERTS, TELEGRAM_CHANNEL_URL]):
    logger.critical("FATAL ERROR: One or more environment variables are missing.")
    exit(1)

# --- 2. –£–ü–†–ê–í–õ–ï–ù–ò–ï –î–ê–ù–ù–´–ú–ò ---
DATA_DIR = Path(os.environ.get("RAILWAY_VOLUME_MOUNT_PATH", "/app/data"))
TICKET_COUNTER_FILE = DATA_DIR / "ticket_counter.txt"
USER_STATES_FILE = DATA_DIR / "user_states.json"
TICKETS_DB_FILE = DATA_DIR / "tickets.json"

counter_lock, states_lock, tickets_lock = Lock(), Lock(), Lock()

def load_json_data(file_path, lock):
    with lock:
        if not file_path.exists(): return {}
        try:
            with open(file_path, 'r', encoding='utf-8') as f: return json.load(f)
        except (json.JSONDecodeError, FileNotFoundError): return {}

def save_json_data(data, file_path, lock):
    with lock:
        DATA_DIR.mkdir(parents=True, exist_ok=True)
        with open(file_path, 'w', encoding='utf-8') as f: json.dump(data, f, ensure_ascii=False, indent=4)

def get_and_increment_ticket_number():
    with counter_lock:
        DATA_DIR.mkdir(parents=True, exist_ok=True)
        try: number = int(TICKET_COUNTER_FILE.read_text().strip())
        except (FileNotFoundError, ValueError): number = 1023
        next_number = number + 1
        TICKET_COUNTER_FILE.write_text(str(next_number))
        return next_number

user_states = load_json_data(USER_STATES_FILE, states_lock)
tickets_db = load_json_data(TICKETS_DB_FILE, tickets_lock)

# --- 3. –¢–ï–ö–°–¢–´ –ò –ö–û–ù–°–¢–ê–ù–¢–´ ---
LEGAL_POLICY_TEXT = """
üìÑ *–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏*

1\.  *–û–±—â–∏–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è*
    1.1. –ù–∞—Å—Ç–æ—è—â–∞—è –ü–æ–ª–∏—Ç–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∑–∞—â–∏—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–∞–ª–µ–µ ‚Äì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏) –°–µ—Ä–≤–∏—Å–∞ ¬´–ù–µ–π—Ä–æ-–ê–¥–≤–æ–∫–∞—Ç¬ª (–¥–∞–ª–µ–µ ‚Äì –°–µ—Ä–≤–∏—Å).
    1.2. *–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –°–µ—Ä–≤–∏—Å–∞ –æ–∑–Ω–∞—á–∞–µ—Ç –±–µ–∑–æ–≥–æ–≤–æ—Ä–æ—á–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–∞—Å—Ç–æ—è—â–µ–π –ü–æ–ª–∏—Ç–∏–∫–æ–π –∏ —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –≤ –Ω–µ–π —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.* –í —Å–ª—É—á–∞–µ –Ω–µ—Å–æ–≥–ª–∞—Å–∏—è —Å —ç—Ç–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–æ–∑–¥–µ—Ä–∂–∞—Ç—å—Å—è –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –°–µ—Ä–≤–∏—Å–∞.

2\.  *–°–æ—Å—Ç–∞–≤ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö*
    2.1. –°–µ—Ä–≤–∏—Å —Å–æ–±–∏—Ä–∞–µ—Ç –∏ —Ö—Ä–∞–Ω–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:
    - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Telegram User ID).
    - –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∏–º –≤ Telegram –∏/–∏–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–µ –°–µ—Ä–≤–∏—Å—É.
    - –õ—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Ñ–∞–π–ª—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤ –∞–¥—Ä–µ—Å –°–µ—Ä–≤–∏—Å–∞.

3\.  *–¶–µ–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö*
    3.1. –î–∞–Ω–Ω—ã–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å —Ü–µ–ª—å—é –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —É—Å–ª—É–≥ –°–µ—Ä–≤–∏—Å–∞, –∞ –∏–º–µ–Ω–Ω–æ ‚Äì –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –µ–≥–æ —Å–∏—Ç—É–∞—Ü–∏–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞.

4\.  *–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö*
    4.1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–∑–Ω–∞–µ—Ç –∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç—Å—è, —á—Ç–æ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ (–ò–ò).
    4.2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –°–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –º–µ—Ä—ã –¥–ª—è –∑–∞—â–∏—Ç—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ—Ç –Ω–µ–ø—Ä–∞–≤–æ–º–µ—Ä–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞.
    4.3. *–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –°–µ—Ä–≤–∏—Å–∞ –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∏—Ö –ø–µ—Ä–µ–¥–∞—á–µ —á–µ—Ä–µ–∑ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É Telegram, –∞ —Ç–∞–∫–∂–µ –ø—Ä–∏ –∏—Ö —Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö —Ö–æ—Å—Ç–∏–Ω–≥-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤.*

5\.  *–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ü–æ–ª–∏—Ç–∏–∫–∏*
    5.1. –°–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç–æ—è—â—É—é –ü–æ–ª–∏—Ç–∏–∫—É –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ. –ù–æ–≤–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è –ü–æ–ª–∏—Ç–∏–∫–∏ –≤—Å—Ç—É–ø–∞–µ—Ç –≤ —Å–∏–ª—É —Å –º–æ–º–µ–Ω—Ç–∞ –µ–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ –∏–Ω–æ–µ –Ω–µ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω–æ –Ω–æ–≤–æ–π —Ä–µ–¥–∞–∫—Ü–∏–µ–π.
"""
LEGAL_DISCLAIMER_TEXT = """
‚ö†Ô∏è *–û—Ç–∫–∞–∑ –æ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (Disclaimer)*

1\.  *–°—Ç–∞—Ç—É—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏*
    1.1. –°–µ—Ä–≤–∏—Å ¬´–ù–µ–π—Ä–æ-–ê–¥–≤–æ–∫–∞—Ç¬ª —è–≤–ª—è–µ—Ç—Å—è *–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–º –ø—Ä–æ–¥—É–∫—Ç–æ–º*, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–º –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞ (–ò–ò) –∏ –ø–æ—Å–ª–µ–¥—É—é—â—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ *—à–∞–±–ª–æ–Ω–æ–≤ (–ø—Ä–æ–µ–∫—Ç–æ–≤)* —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
    1.2. *–£—Å–ª—É–≥–∏ –°–µ—Ä–≤–∏—Å–∞ –∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –∏–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –ù–ï –Ø–í–õ–Ø–Æ–¢–°–Ø —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º –∑–∞–∫–ª—é—á–µ–Ω–∏–µ–º –∏–ª–∏ –∞–¥–≤–æ–∫–∞—Ç—Å–∫–æ–π –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é.*

2\.  *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≥–∞—Ä–∞–Ω—Ç–∏–π*
    2.1. –°–µ—Ä–≤–∏—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ —É—Å–ª–æ–≤–∏—è—Ö *¬´–ö–ê–ö –ï–°–¢–¨¬ª (‚ÄúAS IS‚Äù)* –∏ *¬´–ö–ê–ö –î–û–°–¢–£–ü–ù–û¬ª (‚ÄúAS AVAILABLE‚Äù)*.
    2.2. –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –°–µ—Ä–≤–∏—Å–∞ *–Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –≥–∞—Ä–∞–Ω—Ç–∏–π* –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ —Ç–æ–≥–æ, —á—Ç–æ: –°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è; —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª—É—á–µ–Ω—ã —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –°–µ—Ä–≤–∏—Å–∞, –±—É–¥—É—Ç —Ç–æ—á–Ω—ã–º–∏, –±–µ–∑–æ—à–∏–±–æ—á–Ω—ã–º–∏ –∏–ª–∏ –Ω–∞–¥–µ–∂–Ω—ã–º–∏; –∫–∞—á–µ—Å—Ç–≤–æ –ª—é–±–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞, —É—Å–ª—É–≥–∏ –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±—É–¥–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è–º –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

3\.  *–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è*
    3.1. *–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ—Å–µ—Ç –ø–æ–ª–Ω—É—é, –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—É—é –∏ –µ–¥–∏–Ω–æ–ª–∏—á–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å* –∑–∞ –ª—é–±–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ, –∞–¥–∞–ø—Ç–∞—Ü–∏—é –∏ –ø–æ–¥–∞—á—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–º–æ—â—å—é –°–µ—Ä–≤–∏—Å–∞.
    3.2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å–æ–∑–Ω–∞–µ—Ç —Ä–∏—Å–∫–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò, –≤–∫–ª—é—á–∞—è –≤–æ–∑–º–æ–∂–Ω—ã–µ –Ω–µ—Ç–æ—á–Ω–æ—Å—Ç–∏, –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –∏–ª–∏ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ.
    3.3. *–ü–µ—Ä–µ–¥ –ª—é–±—ã–º –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–º –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±—è–∑–∞–Ω —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Ö —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏/–∏–ª–∏ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å –∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —é—Ä–∏—Å—Ç–æ–º.*

4\.  *–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –°–µ—Ä–≤–∏—Å–∞*
    4.1. –ù–∏ –ø—Ä–∏ –∫–∞–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞—Ö –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è –°–µ—Ä–≤–∏—Å–∞ –∏–ª–∏ –µ–µ –∞—Ñ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–∏—Ü–∞ *–Ω–µ –Ω–µ—Å—É—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏* –∑–∞ –ª—é–±–æ–π –ø—Ä—è–º–æ–π, –∫–æ—Å–≤–µ–Ω–Ω—ã–π, —Å–ª—É—á–∞–π–Ω—ã–π, –ø–æ—Å–ª–µ–¥—É—é—â–∏–π –∏–ª–∏ —à—Ç—Ä–∞—Ñ–Ω–æ–π —É—â–µ—Ä–± (–≤–∫–ª—é—á–∞—è, –Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å, —É–ø—É—â–µ–Ω–Ω—É—é –≤—ã–≥–æ–¥—É, –ø–æ—Ç–µ—Ä—é –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ –¥–µ–ª–æ–≤–æ–π —Ä–µ–ø—É—Ç–∞—Ü–∏–∏), –≤–æ–∑–Ω–∏–∫—à–∏–π –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –°–µ—Ä–≤–∏—Å–∞ –∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.
"""
LEGAL_OFERTA_TEXT = """
üìë *–î–æ–≥–æ–≤–æ—Ä –ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã*

–ù–∞—Å—Ç–æ—è—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º (–ø—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç–æ–π) –°–µ—Ä–≤–∏—Å–∞ ¬´–ù–µ–π—Ä–æ-–ê–¥–≤–æ–∫–∞—Ç¬ª (–¥–∞–ª–µ–µ ‚Äì –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å) –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —É—Å–ª—É–≥.

1\.  *–¢–µ—Ä–º–∏–Ω—ã –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è*
    - *–û—Ñ–µ—Ä—Ç–∞* ‚Äì –Ω–∞—Å—Ç–æ—è—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç.
    - *–ê–∫—Ü–µ–ø—Ç –û—Ñ–µ—Ä—Ç—ã* ‚Äì –ø–æ–ª–Ω–æ–µ –∏ –±–µ–∑–æ–≥–æ–≤–æ—Ä–æ—á–Ω–æ–µ –ø—Ä–∏–Ω—è—Ç–∏–µ –û—Ñ–µ—Ä—Ç—ã –ø—É—Ç–µ–º —Å–æ–≤–µ—Ä—à–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π, —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≤ –ø. 3.2.
    - *–ó–∞–∫–∞–∑—á–∏–∫* ‚Äì –ª—é–±–æ–µ –ª–∏—Ü–æ, —Å–æ–≤–µ—Ä—à–∏–≤—à–µ–µ –ê–∫—Ü–µ–ø—Ç –û—Ñ–µ—Ä—Ç—ã.
    - *–£—Å–ª—É–≥–∞* ‚Äì –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ó–∞–∫–∞–∑—á–∏–∫—É –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º—É –°–µ—Ä–≤–∏—Å—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ (—à–∞–±–ª–æ–Ω–∞) —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –ó–∞–∫–∞–∑—á–∏–∫–æ–º –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò –∏ –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.

2\.  *–ü—Ä–µ–¥–º–µ—Ç –¥–æ–≥–æ–≤–æ—Ä–∞*
    2.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –æ–∫–∞–∑–∞—Ç—å –ó–∞–∫–∞–∑—á–∏–∫—É –£—Å–ª—É–≥—É, –∞ –ó–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–∏–Ω—è—Ç—å –∏ –æ–ø–ª–∞—Ç–∏—Ç—å –µ–µ.
    2.2. *–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –£—Å–ª—É–≥–∏ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ —Å –ø—Ä–æ–µ–∫—Ç–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞.* –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ –∫–∞–∫–∏—Ö-–ª–∏–±–æ —Ü–µ–ª–µ–π –ó–∞–∫–∞–∑—á–∏–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—ã–∏–≥—Ä—ã—à –≤ —Å—É–¥–µ, —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏ –∏ —Ç.–¥.).

3\.  *–ü–æ—Ä—è–¥–æ–∫ –∑–∞–∫–ª—é—á–µ–Ω–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å*
    3.1. –ù–∞—Å—Ç–æ—è—â–∏–π –¥–æ–≥–æ–≤–æ—Ä —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–∫–ª—é—á–µ–Ω–Ω—ã–º —Å –º–æ–º–µ–Ω—Ç–∞ –ê–∫—Ü–µ–ø—Ç–∞ –æ—Ñ–µ—Ä—Ç—ã –ó–∞–∫–∞–∑—á–∏–∫–æ–º.
    3.2. *–ê–∫—Ü–µ–ø—Ç–æ–º –û—Ñ–µ—Ä—Ç—ã —è–≤–ª—è–µ—Ç—Å—è –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—Ä–∞—â–µ–Ω–∏—è* (–Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ ¬´–°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ –ø–æ —ç—Ç–æ–π —Ç–µ–º–µ¬ª –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ–π).
    3.3. –°—Ç–æ–∏–º–æ—Å—Ç—å –£—Å–ª—É–≥–∏ —è–≤–ª—è–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∏ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç *3500 (—Ç—Ä–∏ —Ç—ã—Å—è—á–∏ –ø—è—Ç—å—Å–æ—Ç) —Ä—É–±–ª–µ–π*.

4\.  *–ü—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ —Å—Ç–æ—Ä–æ–Ω*
    4.1. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –≤ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –ø–æ—Ä—è–¥–∫–µ –∏–∑–º–µ–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è –Ω–∞—Å—Ç–æ—è—â–µ–π –û—Ñ–µ—Ä—Ç—ã.
    4.2. –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –≤–ø—Ä–∞–≤–µ –æ—Ç–∫–∞–∑–∞—Ç—å –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –£—Å–ª—É–≥ –ª—é–±–æ–º—É –ª–∏—Ü—É –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø—Ä–∏—á–∏–Ω.
    4.3. –ó–∞–∫–∞–∑—á–∏–∫ –æ–±—è–∑—É–µ—Ç—Å—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –¥–ª—è –æ–∫–∞–∑–∞–Ω–∏—è –£—Å–ª—É–≥.
    4.4. –û–ø–ª–∞—Ç–∞ –£—Å–ª—É–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ó–∞–∫–∞–∑—á–∏–∫–æ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –º–∞–∫–µ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞. *–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ (.docx) –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.*

5\.  *–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å —Å—Ç–æ—Ä–æ–Ω*
    5.1. *–°–æ–≤–æ–∫—É–ø–Ω–∞—è –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –î–æ–≥–æ–≤–æ—Ä—É –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç—Å—è —Å—É–º–º–æ–π –ø–ª–∞—Ç–µ–∂–∞, —É–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ó–∞–∫–∞–∑—á–∏–∫–æ–º –∑–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –£—Å–ª—É–≥—É.*
    5.2. –í—Å–µ —Å–ø–æ—Ä—ã —Ä–µ—à–∞—é—Ç—Å—è –ø—É—Ç–µ–º –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–æ–≤. –ü—Ä–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–∏—è —Å–ø–æ—Ä—ã –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ –≤ —Å—É–¥ –ø–æ –º–µ—Å—Ç—É –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è.
"""
SERVICE_DESCRIPTIONS = {
    "civil": (
        "‚öñÔ∏è **–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ: –ó–∞—â–∏—Ç–∞ –≤ –ø–æ–≤—Å–µ–¥–Ω–µ–≤–Ω–æ–π –∂–∏–∑–Ω–∏**\n\n"
        "–î–ª—è –∫–∞–∂–¥–æ–≥–æ, –∫—Ç–æ —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å—é: –ø—Ä–æ–¥–∞–ª–∏ –±—Ä–∞–∫–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä, –Ω–µ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ —Å–¥–µ–ª–∞–ª–∏ —Ä–µ–º–æ–Ω—Ç, "
        "—Ö–∏–º—á–∏—Å—Ç–∫–∞ –∏—Å–ø–æ—Ä—Ç–∏–ª–∞ –≤–µ—â—å, —Å—Ç—Ä–∞—Ö–æ–≤–∞—è –∑–∞–Ω–∏–∂–∞–µ—Ç –≤—ã–ø–ª–∞—Ç—É –ø–æ –î–¢–ü, —Å–æ—Å–µ–¥–∏ –∑–∞—Ç–æ–ø–∏–ª–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É.\n\n"
        "**–ú—ã –≥–æ—Ç–æ–≤–∏–º:**\n"
        "‚Ä¢ **–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏:** –≥—Ä–∞–º–æ—Ç–Ω—ã–π –¥–æ—Å—É–¥–µ–±–Ω—ã–π —à–∞–≥, –∫–æ—Ç–æ—Ä—ã–π —á–∞—Å—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –±–µ–∑ —Å—É–¥–∞.\n"
        "‚Ä¢ **–ò—Å–∫–æ–≤—ã–µ –∑–∞—è–≤–ª–µ–Ω–∏—è:** –æ –≤–æ–∑–≤—Ä–∞—Ç–µ –¥–µ–Ω–µ–≥, –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –Ω–µ—É—Å—Ç–æ–π–∫–∏, –≤–æ–∑–º–µ—â–µ–Ω–∏–∏ —É—â–µ—Ä–±–∞ –∏ –º–æ—Ä–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–¥–∞.\n"
        "‚Ä¢ **–ó–∞—è–≤–ª–µ–Ω–∏—è –Ω–∞ —Å—É–¥–µ–±–Ω—ã–π –ø—Ä–∏–∫–∞–∑:** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤–∑—ã—Å–∫–∞–Ω–∏—è –±–µ—Å—Å–ø–æ—Ä–Ω—ã—Ö –¥–æ–ª–≥–æ–≤."
    ), "family": (
        "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ **–°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ: –î–µ–ª–∏–∫–∞—Ç–Ω–∞—è –ø–æ–º–æ—â—å**\n\n"
        "–î–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏, –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã.\n\n"
        "**–ú—ã –≥–æ—Ç–æ–≤–∏–º:**\n"
        "‚Ä¢ **–ò—Å–∫–æ–≤—ã–µ –∑–∞—è–≤–ª–µ–Ω–∏—è –æ –≤–∑—ã—Å–∫–∞–Ω–∏–∏ –∞–ª–∏–º–µ–Ω—Ç–æ–≤:** –∫–∞–∫ –≤ % –æ—Ç –¥–æ—Ö–æ–¥–∞, —Ç–∞–∫ –∏ –≤ —Ç–≤–µ—Ä–¥–æ–π –¥–µ–Ω–µ–∂–Ω–æ–π —Å—É–º–º–µ (–µ—Å–ª–∏ –¥–æ—Ö–æ–¥ ¬´—Å–µ—Ä—ã–π¬ª).\n"
        "‚Ä¢ **–ó–∞—è–≤–ª–µ–Ω–∏—è –æ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏–∏ –±—Ä–∞–∫–∞** (–µ—Å–ª–∏ –Ω–µ—Ç —Å–ø–æ—Ä–∞ –æ –¥–µ—Ç—è—Ö –∏ –∏–º—É—â–µ—Å—Ç–≤–µ).\n"
        "‚Ä¢ **–ü—Ä–æ–µ–∫—Ç—ã —Å–æ–≥–ª–∞—à–µ–Ω–∏–π –æ–± —É–ø–ª–∞—Ç–µ –∞–ª–∏–º–µ–Ω—Ç–æ–≤:** –¥–ª—è –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ–≥–æ –Ω–æ—Ç–∞—Ä–∏–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–µ—Ä–µ–Ω–∏—è."
    ), "housing": (
        "üè† **–ñ–∏–ª–∏—â–Ω–æ–µ –ø—Ä–∞–≤–æ: –í–∞—à –¥–æ–º ‚Äî –≤–∞—à–∞ –∫—Ä–µ–ø–æ—Å—Ç—å**\n\n"
        "–î–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –∏ –∞—Ä–µ–Ω–¥–∞—Ç–æ—Ä–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ä—é—Ç—Å—è —Å –±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ–º –£–ö, —Ä–µ—à–∞—é—Ç —Å–ø–æ—Ä—ã —Å —Å–æ—Å–µ–¥—è–º–∏ –∏–ª–∏ —Ö–æ—Ç—è—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ —Å–¥–µ–ª–∫—É.\n\n"
        "**–ú—ã –≥–æ—Ç–æ–≤–∏–º:**\n"
        "‚Ä¢ **–ñ–∞–ª–æ–±—ã:** –≤ –£–ø—Ä–∞–≤–ª—è—é—â—É—é –∫–æ–º–ø–∞–Ω–∏—é, –ñ–∏–ª–∏—â–Ω—É—é –∏–Ω—Å–ø–µ–∫—Ü–∏—é, –†–æ—Å–ø–æ—Ç—Ä–µ–±–Ω–∞–¥–∑–æ—Ä.\n"
        "‚Ä¢ **–ò—Å–∫–æ–≤—ã–µ –∑–∞—è–≤–ª–µ–Ω–∏—è:** –æ–± –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä–æ–π, –æ –Ω–µ—á–∏–Ω–µ–Ω–∏–∏ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π.\n"
        "‚Ä¢ **–ü—Ä–æ–µ–∫—Ç—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤:** –∫—É–ø–ª–∏-–ø—Ä–æ–¥–∞–∂–∏, –¥–∞—Ä–µ–Ω–∏—è, –∞—Ä–µ–Ω–¥—ã (–Ω–∞–π–º–∞) —Å —É—á–µ—Ç–æ–º –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤."
    ), "military": (
        "üõ°Ô∏è **–í–æ–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–æ –∏ —Å–æ—Ü–æ–±–µ—Å–ø–µ—á–µ–Ω–∏–µ: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞—â–∏—Ç–Ω–∏–∫–æ–≤**\n\n"
        "–î–ª—è –≤–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏—Ö (–≤–∫–ª—é—á–∞—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –°–í–û), –≤–µ—Ç–µ—Ä–∞–Ω–æ–≤ –∏ –∏—Ö —Å–µ–º–µ–π, —Å—Ç–æ–ª–∫–Ω—É–≤—à–∏—Ö—Å—è —Å –±—é—Ä–æ–∫—Ä–∞—Ç–∏–µ–π.\n\n"
        "**–ú—ã –≥–æ—Ç–æ–≤–∏–º:**\n"
        "‚Ä¢ **–ó–∞–ø—Ä–æ—Å—ã –∏ —Ä–∞–ø–æ—Ä—Ç—ã:** –≤ –≤–æ–µ–Ω–∫–æ–º–∞—Ç—ã, –≤/—á, –ï–†–¶ –ú–û –†–§ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞, –≤—ã–ø–ª–∞—Ç, –Ω–∞–≥—Ä–∞–¥.\n"
        "‚Ä¢ **–ó–∞—è–≤–ª–µ–Ω–∏—è:** –Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∞–∫—Ç–æ–≤, –∏–º–µ—é—â–∏—Ö —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É—á–∞—Å—Ç–∏—è –≤ –±–æ–µ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö).\n"
        "‚Ä¢ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏—Å–∫–∏:** –¥–ª—è –æ–±–∂–∞–ª–æ–≤–∞–Ω–∏—è –æ—Ç–∫–∞–∑–æ–≤ –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –≤—ã–ø–ª–∞—Ç –∏ —Å—Ç–∞—Ç—É—Å–æ–≤."
    ), "admin": (
        "üè¢ **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ: –ë–æ—Ä—å–±–∞ —Å –±—é—Ä–æ–∫—Ä–∞—Ç–∏–µ–π**\n\n"
        "–î–ª—è –≥—Ä–∞–∂–¥–∞–Ω, —Å—Ç–æ–ª–∫–Ω—É–≤—à–∏—Ö—Å—è —Å –Ω–µ–∑–∞–∫–æ–Ω–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ —á–∏–Ω–æ–≤–Ω–∏–∫–æ–≤ –∏–ª–∏ –ø–æ–ª—É—á–∏–≤—à–∏—Ö –Ω–µ—Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π —à—Ç—Ä–∞—Ñ.\n\n"
        "**–ú—ã –≥–æ—Ç–æ–≤–∏–º:**\n"
        "‚Ä¢ **–ñ–∞–ª–æ–±—ã:** –Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è/–±–µ–∑–¥–µ–π—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã—Ö –ª–∏—Ü –≤ –ø—Ä–æ–∫—É—Ä–∞—Ç—É—Ä—É –∏–ª–∏ –≤—ã—à–µ—Å—Ç–æ—è—â–∏–µ –æ—Ä–≥–∞–Ω—ã.\n"
        "‚Ä¢ **–ó–∞—è–≤–ª–µ–Ω–∏—è:** –≤ –†–æ—Å–ø–æ—Ç—Ä–µ–±–Ω–∞–¥–∑–æ—Ä, –¢—Ä—É–¥–æ–≤—É—é –∏–Ω—Å–ø–µ–∫—Ü–∏—é.\n"
        "‚Ä¢ **–•–æ–¥–∞—Ç–∞–π—Å—Ç–≤–∞ –∏ –∂–∞–ª–æ–±—ã:** –ø–æ –¥–µ–ª–∞–º –æ–± –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∞–≤–æ–Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –æ—Ç–º–µ–Ω—ã —à—Ç—Ä–∞—Ñ–∞ –ì–ò–ë–î–î)."
    ), "business": (
        "üíº **–î–ª—è –º–∞–ª–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞ –∏ —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö: –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∏–π —â–∏—Ç**\n\n"
        "–î–ª—è —Ñ—Ä–∏–ª–∞–Ω—Å–µ—Ä–æ–≤ –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –∫–æ–º–ø–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω—ã –Ω–∞–¥–µ–∂–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–æ —é—Ä–∏—Å—Ç –≤ —à—Ç–∞—Ç–µ –Ω–µ–≤—ã–≥–æ–¥–µ–Ω.\n\n"
        "**–ú—ã –≥–æ—Ç–æ–≤–∏–º:**\n"
        "‚Ä¢ **–ü—Ä–æ–µ–∫—Ç—ã –¥–æ–≥–æ–≤–æ—Ä–æ–≤:** –æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ª—É–≥, –ø–æ–¥—Ä—è–¥–∞, –ø–æ—Å—Ç–∞–≤–∫–∏ —Å –∑–∞—â–∏—Ç–æ–π –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å —É—Å–ª–æ–≤–∏–µ–º –æ–± –æ–ø–ª–∞—Ç–µ).\n"
        "‚Ä¢ **–ü—Ä–µ—Ç–µ–Ω–∑–∏–∏:** –∫ –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º-–¥–æ–ª–∂–Ω–∏–∫–∞–º –¥–ª—è –≤–∑—ã—Å–∫–∞–Ω–∏—è –æ–ø–ª–∞—Ç—ã.\n"
        "‚Ä¢ **–ê–∫—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç** –∏ –¥—Ä—É–≥–∏–µ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã."
    )
}
FAQ_ANSWERS = {
    "price": "–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ª—é–±–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ ‚Äî **3500 ‚ÇΩ**.\n\n–≠—Ç–æ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞, –≤ –∫–æ—Ç–æ—Ä—É—é —É–∂–µ –≤–∫–ª—é—á–µ–Ω –∞–Ω–∞–ª–∏–∑ –≤–∞—à–µ–π —Å–∏—Ç—É–∞—Ü–∏–∏, —Ä–∞–±–æ—Ç–∞ –ò–ò –∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —é—Ä–∏—Å—Ç–æ–º.",
    "payment_and_delivery": (
        "–ü—Ä–æ—Ü–µ—Å—Å –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **–ø–æ–ª–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –∏ –æ–ø–ª–∞—Ç–µ –∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç**:\n\n"
        "1Ô∏è‚É£ –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –Ω–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç (¬´–î–∏—Ä–∏–∂–µ—Ä¬ª) —É—Ç–æ—á–Ω–∏—Ç –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –º—ã –≥–æ—Ç–æ–≤–∏–º –¥–æ–∫—É–º–µ–Ω—Ç.\n\n"
        "2Ô∏è‚É£ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ **PDF-–≤–µ—Ä—Å–∏—é —Å –≤–æ–¥—è–Ω—ã–º–∏ –∑–Ω–∞–∫–∞–º–∏** –¥–ª—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏. –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ –æ—Ç –∫–æ—Ä–∫–∏ –¥–æ –∫–æ—Ä–∫–∏ –∏ —É–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–∞—á–µ—Å—Ç–≤–µ.\n\n"
        "3Ô∏è‚É£ –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∫–∏ ‚Äî –≤—ã —Å–æ–æ–±—â–∞–µ—Ç–µ –æ –Ω–∏—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä—É, –∏ –º—ã –∏—Ö –≤–Ω–æ—Å–∏–º.\n\n"
        "4Ô∏è‚É£ **–¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–∞—à–µ–≥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ '–û–ö'**, –≤—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É –ª—é–±—ã–º —É–¥–æ–±–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º (–∫–∞—Ä—Ç–∞, –°–ë–ü).\n\n"
        "5Ô∏è‚É£ –ú–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ **—Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .docx (Word)**, –≥–æ—Ç–æ–≤—ã–π –∫ –ø–µ—á–∞—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é."
    ),
    "template": "–≠—Ç–æ **–Ω–µ —à–∞–±–ª–æ–Ω**.\n\n–ö–∞–∂–¥—ã–π –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ–∑–¥–∞–µ—Ç—Å—è –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –∏ —Å—É–¥–µ–±–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–∏, –∞ –∑–∞—Ç–µ–º **–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ** –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏ –¥–æ–≤–æ–¥–∏—Ç—Å—è –¥–æ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–∞ –∂–∏–≤—ã–º —é—Ä–∏—Å—Ç–æ–º-¬´–î–∏—Ä–∏–∂–µ—Ä–æ–º¬ª.",
    "timing": "–û–±—ã—á–Ω–æ –æ—Ç **3 –¥–æ 24 —á–∞—Å–æ–≤** —Å –º–æ–º–µ–Ω—Ç–∞, –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ–ª—É—á–∏—Ç –æ—Ç –≤–∞—Å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.",
    "guarantee": "–ù–∏ –æ–¥–∏–Ω —é—Ä–∏—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –¥–∞—Ç—å 100% –≥–∞—Ä–∞–Ω—Ç–∏—é –≤—ã–∏–≥—Ä—ã—à–∞. –ú—ã **–≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º**, —á—Ç–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–∞–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç –±—É–¥–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏ –≥—Ä–∞–º–æ—Ç–Ω—ã–º, —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º —Å —É—á–µ—Ç–æ–º –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤."
}
CATEGORY_NAMES = {"civil": "–ì—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–µ –ø—Ä–∞–≤–æ", "family": "–°–µ–º–µ–π–Ω–æ–µ –ø—Ä–∞–≤–æ", "housing": "–ñ–∏–ª–∏—â–Ω–æ–µ –ø—Ä–∞–≤–æ", "military": "–í–æ–µ–Ω–Ω–æ–µ –ø—Ä–∞–≤–æ", "admin": "–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∞–≤–æ", "business": "–ú–∞–ª—ã–π –±–∏–∑–Ω–µ—Å"}
STATUS_EMOJI = {"new": "üÜï", "in_progress": "‚è≥", "closed": "‚úÖ", "declined": "‚ùå"}
STATUS_TEXT = {"new": "–ù–æ–≤–æ–µ", "in_progress": "–í —Ä–∞–±–æ—Ç–µ", "closed": "–ó–∞–≤–µ—Ä—à–µ–Ω–æ", "declined": "–û—Ç–∫–ª–æ–Ω–µ–Ω–æ"}

# --- 4. –§–£–ù–ö–¶–ò–ò –ò–ù–¢–ï–†–§–ï–ô–°–ê –ò –ö–û–ú–ê–ù–î–´ ---

async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é."""
    keyboard = [
        [InlineKeyboardButton("‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ", callback_data='show_services_menu')],
        [InlineKeyboardButton("üóÇÔ∏è –ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è", callback_data='my_tickets')],
        [InlineKeyboardButton("‚ùì –ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã (FAQ)", callback_data='show_faq_menu')],
        [InlineKeyboardButton("‚öñÔ∏è –Æ—Ä–∏–¥–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è", callback_data='show_legal_menu')],
        [InlineKeyboardButton("üì¢ –ù–∞—à –∫–∞–Ω–∞–ª", url=TELEGRAM_CHANNEL_URL)]
    ]
    text = (
        "*–í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç ¬´–ù–µ–π—Ä–æ-–ê–¥–≤–æ–∫–∞—Ç¬ª*\n\n"
        "–ú—ã –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å–µ—Ä–≤–∏—Å. –ú—ã ‚Äî –≤–∞—à –ª–∏—á–Ω—ã–π –∞—Ä—Å–µ–Ω–∞–ª –¥–ª—è –∑–∞—â–∏—Ç—ã –ø—Ä–∞–≤. "
        "–ö–∞–∂–¥–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∑–¥–µ—Å—å ‚Äî —ç—Ç–æ –Ω–∞—á–∞–ª–æ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≥–¥–µ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç ¬´–î–∏—Ä–∏–∂–µ—Ä–∞¬ª –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –º–æ—â—å ¬´–û—Ä–∫–µ—Å—Ç—Ä–∞¬ª –¥–ª—è –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–π —Ü–µ–ª–∏ ‚Äî **–≤–∞—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞**.\n\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ *¬´–ú–æ–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è¬ª* –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ª–∏—á–Ω–æ–º—É –∫–∞–±–∏–Ω–µ—Ç—É –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤–∞—à–∏—Ö –∑–∞–¥–∞—á."
    )
    
    target_message = update.callback_query.message if update.callback_query else update.message
    try:
        if update.callback_query:
            await target_message.edit_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)
        else:
            await target_message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        logger.error(f"Error in show_main_menu: {e}")

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = str(update.effective_user.id)
    if user_id in user_states:
        del user_states[user_id]
        save_json_data(user_states, USER_STATES_FILE, states_lock)
    await update.message.reply_text("–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã...", reply_markup=ReplyKeyboardRemove())
    await show_main_menu(update, context)

async def cancel_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    user_id = str(update.effective_user.id)
    state_data = user_states.get(user_id, {})
    
    if state_data.get('state') in ['ask_name', 'collecting_data']:
        ticket_id_to_delete = state_data.get('active_ticket')
        if ticket_id_to_delete:
            with tickets_lock:
                if ticket_id_to_delete in tickets_db:
                    del tickets_db[ticket_id_to_delete]
                    save_json_data(tickets_db, TICKETS_DB_FILE, tickets_lock)
                    logger.info(f"Orphaned ticket {ticket_id_to_delete} was deleted due to /cancel.")
        if user_id in user_states:
            del user_states[user_id]
            save_json_data(user_states, USER_STATES_FILE, states_lock)
        await update.message.reply_text("–°–æ–∑–¥–∞–Ω–∏–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=ReplyKeyboardRemove())
    else:
        await update.message.reply_text("–ù–µ—á–µ–≥–æ –æ—Ç–º–µ–Ω—è—Ç—å. –í—ã —É–∂–µ –≤ –≥–ª–∞–≤–Ω–æ–º –º–µ–Ω—é.", reply_markup=ReplyKeyboardRemove())
    await show_main_menu(update, context)

async def exit_chat_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    if user_states.get(user_id, {}).get('state') == 'in_ticket_chat':
        del user_states[user_id]
        save_json_data(user_states, USER_STATES_FILE, states_lock)
        await update.message.reply_text("–í—ã –≤—ã—à–ª–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —á–∞—Ç–∞.")
        await show_main_menu(update, context)

# --- 5. –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ---

async def my_tickets_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = str(update.effective_user.id)
    user_tickets = {k: v for k, v in tickets_db.items() if v.get('user_id') == user_id}
    message_text = "üóÇÔ∏è *–í–∞—à–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è:*"
    if not user_tickets:
        message_text = "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è."
        keyboard = [[InlineKeyboardButton("‚úçÔ∏è –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ", callback_data='show_services_menu')]]
    else:
        keyboard = []
        for ticket_id, ticket_data in sorted(user_tickets.items(), key=lambda item: int(item[0]), reverse=True):
            status_emoji = STATUS_EMOJI.get(ticket_data.get('status', 'new'), '‚ùì')
            category = escape_markdown(ticket_data.get('category', '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'))
            button_text = f"{status_emoji} –û–±—Ä–∞—â–µ–Ω–∏–µ ‚Ññ{ticket_id} ({category})"
            keyboard.append([InlineKeyboardButton(button_text, callback_data=f"view_ticket_{ticket_id}")])
    
    keyboard.append([InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data='back_to_start')])
    
    target = update.callback_query.message if update.callback_query else update.message
    try:
        if update.callback_query:
            await target.edit_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)
        else:
            await target.reply_text(message_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        logger.error(f"Error in my_tickets_action: {e}")

async def view_ticket_action(update: Update, context: ContextTypes.DEFAULT_TYPE, ticket_id: str):
    user_id = str(update.effective_user.id)
    ticket_data = tickets_db.get(ticket_id)
    if not ticket_data or ticket_data.get('user_id') != user_id:
        await update.callback_query.edit_message_text("–û–±—Ä–∞—â–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø–∞.")
        return

    chat_history = "üí¨ *–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–ø–∏—Å–∫–∏:*\n\n"
    if not ticket_data.get('chat_history'):
        chat_history += "_–ü–µ—Ä–µ–ø–∏—Å–∫–∞ –ø–æ–∫–∞ –ø—É—Å—Ç–∞._"
    else:
        for msg in ticket_data['chat_history']:
            sender = "–í—ã" if msg['sender'] == 'user' else "–û–ø–µ—Ä–∞—Ç–æ—Ä"
            escaped_text = escape_markdown(msg['text'])
            chat_history += f"**{sender}:** {escaped_text}\n"
    
    status_text = escape_markdown(STATUS_TEXT.get(ticket_data.get('status', 'new'), "–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"))
    
    user_states[user_id] = {'state': 'in_ticket_chat', 'active_ticket': ticket_id}
    save_json_data(user_states, USER_STATES_FILE, states_lock)
    
    reply_text = (f"*–û–±—Ä–∞—â–µ–Ω–∏–µ ‚Ññ{ticket_id}*\n"
                  f"*–°—Ç–∞—Ç—É—Å:* {status_text}\n\n{chat_history}\n\n"
                  "------------------\n"
                  "–í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º–µ —á–∞—Ç–∞ –ø–æ —ç—Ç–æ–º—É –æ–±—Ä–∞—â–µ–Ω–∏—é. –í—Å–µ –≤–∞—à–∏ —Å–ª–µ–¥—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.\n"
                  "–ß—Ç–æ–±—ã –≤—ã–π—Ç–∏, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /exit_chat")
    
    await update.callback_query.edit_message_text(reply_text, parse_mode=ParseMode.MARKDOWN)

# --- 6. –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–ï–ô–°–¢–í–ò–ô (–ú–ê–†–®–†–£–¢–ò–ó–ê–¢–û–†) ---

async def inline_button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    data = query.data

    if data == 'my_tickets':
        await my_tickets_action(update, context)
    elif data.startswith('view_ticket_'):
        await view_ticket_action(update, context, data.split('_')[2])
    elif data.startswith('take_') or data.startswith('decline_'):
        await take_decline_ticket_action(update, context)
    elif data.startswith('op_'):
        await operator_panel_action(update, context)
    elif data == 'show_legal_menu' or data.startswith('legal_'):
        await legal_menu_action(update, context)
    elif data == 'show_services_menu' or data.startswith('service_'):
        await services_menu_action(update, context)
    elif data == 'show_faq_menu' or data.startswith('faq_'):
        await faq_menu_action(update, context)
    elif data.startswith('order_'):
        await order_action(update, context)
    elif data == 'back_to_start':
        await show_main_menu(update, context)
    else:
        logger.warning(f"Unhandled callback_data: {data}")

async def take_decline_ticket_action(query: Update, context: ContextTypes.DEFAULT_TYPE):
    parts = query.data.split('_')
    action, ticket_id, client_user_id = parts[0], parts[1], parts[2]
    
    with tickets_lock:
        ticket_data = tickets_db.get(ticket_id)
        if not ticket_data:
            await query.answer("–≠—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ –±–æ–ª—å—à–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!", show_alert=True)
            return
        if ticket_data['status'] != 'new':
            operator_name = escape_markdown(ticket_data.get('operator_name', '–¥—Ä—É–≥–∏–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º'))
            status_text = STATUS_TEXT.get(ticket_data['status'], '–æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ')
            await query.answer(f"–≠—Ç–æ –æ–±—Ä–∞—â–µ–Ω–∏–µ —É–∂–µ {status_text} ({operator_name}).", show_alert=True)
            return

        operator_name_raw = query.from_user.full_name
        ticket_data['operator_id'] = str(query.from_user.id)
        ticket_data['operator_name'] = operator_name_raw
        
        if action == 'take':
            ticket_data['status'] = 'in_progress'
            notification_text = f"‚úÖ *–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω:* –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ ‚Ññ{ticket_id} –ø—Ä–∏–Ω—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É."
            operator_action_text = f"**‚úÖ –í–∑—è—Ç–æ –≤ —Ä–∞–±–æ—Ç—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º {escape_markdown(operator_name_raw)}**"
            new_keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("üí¨ –ó–∞–ø—Ä–æ—Å–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é", callback_data=f"op_ask_{ticket_id}_{client_user_id}")],
                [InlineKeyboardButton("üìÑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É", callback_data=f"op_review_{ticket_id}_{client_user_id}")],
                [InlineKeyboardButton("üèÅ –ó–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ", callback_data=f"op_close_{ticket_id}_{client_user_id}")]
            ])
        else: # decline
            ticket_data['status'] = 'declined'
            notification_text = f"‚ùå –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –º—ã –Ω–µ –º–æ–∂–µ–º –≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É –≤–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ ‚Ññ{ticket_id} –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç."
            operator_action_text = f"**‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º {escape_markdown(operator_name_raw)}**"
            new_keyboard = None
        
        save_json_data(tickets_db, TICKETS_DB_FILE, tickets_lock)

    try:
        await context.bot.send_message(chat_id=int(client_user_id), text=notification_text, parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        logger.error(f"Failed to send status update to client {client_user_id}: {e}")
        
    new_text = f"{query.message.text_markdown}\n\n{operator_action_text}"
    await query.edit_message_text(new_text, parse_mode=ParseMode.MARKDOWN, reply_markup=new_keyboard)

async def operator_panel_action(query: Update, context: ContextTypes.DEFAULT_TYPE):
    parts = query.data.split('_')
    action, ticket_id, client_user_id = parts[1], parts[2], parts[3]
    
    if action == 'close':
        with tickets_lock:
            if ticket_id in tickets_db:
                tickets_db[ticket_id]['status'] = 'closed'
                save_json_data(tickets_db, TICKETS_DB_FILE, tickets_lock)
        operator_name = escape_markdown(query.from_user.full_name)
        new_text = f"{query.message.text_markdown}\n\n**üèÅ –û–±—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º {operator_name}**"
        await query.edit_message_text(new_text, parse_mode=ParseMode.MARKDOWN, reply_markup=None)
        await context.bot.send_message(chat_id=int(client_user_id), text=f"‚úÖ –í–∞—à–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ ‚Ññ{ticket_id} —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–ø–∞—Å–∏–±–æ!")
        return

    message_text = ""
    alert_text = "‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!"
    if action == 'ask':
        message_text = f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ü–æ –≤–∞—à–µ–º—É –æ–±—Ä–∞—â–µ–Ω–∏—é ‚Ññ{ticket_id} —Ç—Ä–µ–±—É—é—Ç—Å—è —É—Ç–æ—á–Ω–µ–Ω–∏—è. –°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å–∫–æ—Ä–æ –Ω–∞–ø–∏—à–µ—Ç –≤–∞–º."
    elif action == 'review':
        message_text = f"üìÑ *–î–æ–∫—É–º–µ–Ω—Ç –ø–æ –æ–±—Ä–∞—â–µ–Ω–∏—é ‚Ññ{ticket_id} –≥–æ—Ç–æ–≤!* –ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –µ–≥–æ –≤–∞–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É."
        
    try:
        if message_text: await context.bot.send_message(chat_id=int(client_user_id), text=message_text, parse_mode=ParseMode.MARKDOWN)
        await query.answer(alert_text, show_alert=True)
    except Exception:
        await query.answer("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É.", show_alert=True)

async def legal_menu_action(query: Update, context: ContextTypes.DEFAULT_TYPE):
    data = query.data
    if data == 'show_legal_menu':
        keyboard = [
            [InlineKeyboardButton




